<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>GeoCSV Explorer</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body { font-family:"Segoe UI",Arial,sans-serif; background:#f5f6fa; margin:0; padding:0; }
header { background:#2b7de9; color:white; padding:15px 0; text-align:center; font-size:1.5em; font-weight:600; }
#controls { text-align:center; margin:15px; }
#summary { display:flex; justify-content:center; flex-wrap:wrap; gap:15px; margin-bottom:10px; }
.summary-card { background:white; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.1); padding:10px 20px; min-width:150px; text-align:center; }
.summary-card h3 { margin:5px 0; color:#2b7de9; font-size:1.4em; }
.summary-card p { margin:0; color:#555; font-size:0.9em; }
main { display:flex; flex-wrap:wrap; justify-content:space-around; align-items:flex-start; padding:20px; gap:20px; }
#chartContainer, #map { flex:1 1 45%; min-width:400px; height:500px; background:white; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:15px; }
#map { padding:0; }
select, input[type="file"] { padding:6px 10px; margin:0 10px; font-size:1em; }
canvas { width:100%; height:100%; }
</style>
</head>
<body>
<header>GeoCSV Explorer</header>

<div id="controls">
<input type="file" id="fileInput" accept=".csv"/>
<label for="statSelect">Statistica:</label>
<select id="statSelect">
<option value="media">Media</option>
<option value="mediana">Mediana</option>
<option value="devstd">Deviazione standard</option>
</select>
<label for="numFieldSelect">Campo numerico:</label>
<select id="numFieldSelect"></select>
<label for="catFieldSelect">Campo categoriale (mappa):</label>
<select id="catFieldSelect"></select>
<label for="chartTypeSelect">Tipo grafico:</label>
<select id="chartTypeSelect">
<option value="bar">Barre</option>
<option value="scatter">Scatter + trend</option>
</select>
</div>

<div id="summary">
<div class="summary-card"><h3 id="totPunti">0</h3><p>Punti totali</p></div>
<div class="summary-card"><h3 id="totCategorie">0</h3><p>Valori distinti categoriali</p></div>
<div class="summary-card"><h3 id="mediaGlobale">–</h3><p>Media globale</p></div>
<div class="summary-card"><h3 id="rangeGlobale">–</h3><p>Min - Max</p></div>
</div>

<main>
<div id="chartContainer"><canvas id="chart"></canvas></div>
<div id="map"></div>
</main>

<script>
let myChart;
const ctx = document.getElementById('chart').getContext('2d');
const map = L.map('map').setView([40,9],6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ maxZoom:18, attribution:'&copy; OpenStreetMap contributors' }).addTo(map);
let markersLayer = L.layerGroup().addTo(map);
const palette = ['#1f77b4','#ff7f0e','#2ca02c','#d62728','#9467bd','#8c564b','#e377c2','#7f7f7f','#bcbd22','#17becf'];

const median = arr => { const s = arr.slice().sort((a,b)=>a-b); const mid = Math.floor(s.length/2); return s.length%2!==0?s[mid]:(s[mid-1]+s[mid])/2; };
const stdDev = arr => { const m = arr.reduce((a,b)=>a+b,0)/arr.length; return Math.sqrt(arr.reduce((a,b)=>a+(b-m)**2,0)/arr.length); };

let csvData = [];

document.getElementById('fileInput').addEventListener('change',e=>{
  const file=e.target.files[0];
  Papa.parse(file,{header:true,dynamicTyping:true,skipEmptyLines:true,complete:results=>{
    csvData=results.data;
    populateFieldSelectors();
    updateDashboard();
  }});
});

document.getElementById('statSelect').addEventListener('change',updateDashboard);
document.getElementById('numFieldSelect').addEventListener('change',updateDashboard);
document.getElementById('catFieldSelect').addEventListener('change',updateDashboard);
document.getElementById('chartTypeSelect').addEventListener('change',updateDashboard);

function populateFieldSelectors(){
  const numSelect=document.getElementById('numFieldSelect');
  const catSelect=document.getElementById('catFieldSelect');
  numSelect.innerHTML=''; catSelect.innerHTML='';
  const sample=csvData[0];
  const campi=Object.keys(sample).filter(f=>!['Punto','Lat','Lon','Latitudine','Longitudine','Foto'].includes(f));

  campi.forEach(f=>{
    const isNum=csvData.every(r=>!isNaN(parseFloat(r[f])));
    if(isNum){ const opt=document.createElement('option'); opt.value=f; opt.textContent=f; numSelect.appendChild(opt); }
  });
  campi.forEach(f=>{
    const isCat=csvData.some(r=>isNaN(parseFloat(r[f])));
    if(isCat){ const opt=document.createElement('option'); opt.value=f; opt.textContent=f; catSelect.appendChild(opt); }
  });
}

// Calcola linea di tendenza lineare con 5 punti
function linearTrend(xs,ys,points=5){
  const n=xs.length;
  const sumX=xs.reduce((a,b)=>a+b,0);
  const sumY=ys.reduce((a,b)=>a+b,0);
  const sumXY=xs.reduce((a,b,i)=>a+b*ys[i],0);
  const sumX2=xs.reduce((a,b)=>a+b*b,0);
  const slope=(n*sumXY-sumX*sumY)/(n*sumX2-sumX*sumX);
  const intercept=(sumY-slope*sumX)/n;
  const minX=Math.min(...xs), maxX=Math.max(...xs), step=(maxX-minX)/(points-1);
  const trend=[];
  for(let i=0;i<points;i++){ const x=minX+i*step; trend.push({x:x,y:slope*x+intercept}); }
  return trend;
}

function updateDashboard(){
  if(!csvData.length) return;
  const stat=document.getElementById('statSelect').value;
  const numField=document.getElementById('numFieldSelect').value;
  const catField=document.getElementById('catFieldSelect').value;
  const chartType=document.getElementById('chartTypeSelect').value;

  // --- Campo numerico ---
  const numericValues = [];
  csvData.forEach(r=>{ const val=parseFloat(r[numField]); if(!isNaN(val)) numericValues.push(val); });

  // --- Campo categoriale per mappa ---
  const categoriaCounts = {};
  const colorMap = {};
  csvData.forEach(r=>{
    const cat = r[catField] || 'N/A';
    if(!categoriaCounts[cat]) categoriaCounts[cat]=0;
    categoriaCounts[cat]++;
    if(!colorMap[cat]) colorMap[cat]=palette[Object.keys(colorMap).length%palette.length];
  });

  // --- Grafico ---
  if(chartType==='bar'){
    const gruppi={};
    csvData.forEach(r=>{
      const val=parseFloat(r[numField]);
      const cat=r[catField]||'N/A';
      if(!isNaN(val)){
        if(!gruppi[cat]) gruppi[cat]=[];
        gruppi[cat].push(val);
      }
    });
    const labels=Object.keys(gruppi);
    const values=labels.map(cat=>{
      const vals=gruppi[cat];
      if(stat==='media') return vals.reduce((a,b)=>a+b,0)/vals.length;
      if(stat==='mediana') return median(vals);
      if(stat==='devstd') return stdDev(vals);
    });
    const colors=labels.map(c=>colorMap[c]);
    if(myChart) myChart.destroy();
    myChart=new Chart(ctx,{type:'bar',data:{labels, datasets:[{label:`${numField} (${stat})`,data:values,backgroundColor:colors}]},options:{responsive:true,plugins:{legend:{display:false},title:{display:true,text:`${numField} (${stat}) per ${catField}`,font:{size:16}}},scales:{y:{beginAtZero:true,title:{display:true,text:numField}}}}});
  } else if(chartType==='scatter'){
    const xs=numericValues.map((v,i)=>i+1);
    const ys=numericValues;
    const dataPoints=xs.map((x,i)=>({x:x,y:ys[i]}));
    const trendData=linearTrend(xs,ys,5);
    if(myChart) myChart.destroy();
    myChart=new Chart(ctx,{
      type:'scatter',
      data:{datasets:[{label:numField+' (punti)',data:dataPoints,backgroundColor:'#2b7de9'},{label:'Trend line',data:trendData,type:'line',borderColor:'#ff7f0e',fill:false}]},
      options:{responsive:true,plugins:{legend:{display:true},title:{display:true,text:`Scatterplot ${numField}`,font:{size:16}}},scales:{y:{beginAtZero:true,title:{display:true,text:numField}},x:{title:{display:true,text:'Indice'}}}}
    });
  }

  // --- Riepilogo ---
  const mediaGlobale=(numericValues.reduce((a,b)=>a+b,0)/numericValues.length).toFixed(2);
  const minVal=Math.min(...numericValues).toFixed(2); const maxVal=Math.max(...numericValues).toFixed(2);
  document.getElementById('totPunti').textContent=numericValues.length;
  document.getElementById('totCategorie').textContent=Object.keys(categoriaCounts).length;
  document.getElementById('mediaGlobale').textContent=isNaN(mediaGlobale)?'–':mediaGlobale;
  document.getElementById('rangeGlobale').textContent=isFinite(minVal)?`${minVal} - ${maxVal}`:'–';

  // --- Mappa ---
  markersLayer.clearLayers();
  const markers=[];
  csvData.forEach(r=>{
    const lat=r['Lat']||r['Latitudine']; 
    const lon=r['Lon']||r['Longitudine'];
    const punto=r['Punto']; 
    const catValue=r[catField]||'N/A';
    const foto=r['Foto']; // link immagine
    if(lat && lon){
      const color=colorMap[catValue]||'#999';
      const popupContent = `<b>Punto:</b> ${punto}<br>
                            <b>${catField}:</b> ${catValue}<br>
                            <b>Conteggio categoria:</b> ${categoriaCounts[catValue]}
                            ${foto ? `<br><img src="${foto}" alt="Foto ${punto}" style="width:120px;height:auto;margin-top:5px;">` : ''}`;
      const marker = L.circleMarker([lat, lon], {radius:7,color:color,fillColor:color,fillOpacity:0.8}).bindPopup(popupContent);
      markersLayer.addLayer(marker); markers.push(marker);
    }
  });
  if(markers.length>0){ const group=L.featureGroup(markers); map.fitBounds(group.getBounds().pad(0.2)); }
}
</script>

<footer style="text-align:center; padding:10px; background:#f0f0f0; font-size:0.9em; color:#555;">
  Developed by Enrico Melis
</footer>

<p style="text-align:center; margin-top:5px; font-size:0.9em;">
  Consulta la <a href="https://github.com/r66282309-hub/csv_explorer" target="_blank">Guida</a> su GitHub.
</p>

</body>
</html>
